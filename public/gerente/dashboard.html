<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CenterWatch | Dashboard</title>
    <link rel="stylesheet" href="../css/dashboards.css">
    <link rel="stylesheet" href="../css/dashboardsGerente.css">
    <script src="../js/sessao.js"></script>
    <script src="https://kit.fontawesome.com/384071f692.js" crossorigin="anonymous"></script>
    <script src="../js/sessao.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<body onload="buscarTarefasAtrasadas(),buscarOperadoresComMaisTarefasAtrasadas()">


    <section class="section-body">
        <div class="leftbar">
            <div class="links-nav">
                <img class="logo text-logo" src="https://i.imgur.com/RjhX0a9.png" alt="">
                <a class="nav-btn btn-ativo" href="#"><i class="fa-solid fa-square-poll-vertical"></i><span></i>Dashboard</span></a>
                <a class="nav-btn" href="funcionarios.html"><i class="fa-solid fa-users"></i></i><span>Funcionários</span></a>
                <a class="nav-btn" href="tasks.html"><i class="fa-solid fa-list-check"></i></i><span>Tasks</span></a>
            </div>
            <div class="cfg-nav">
                <a class="nav-btn" href="configuracoes.html"><i
                        class="fa-solid fa-gear"></i><span>Configurações</span></a>
                <a class="nav-btn" onclick="sair()"><i class="fa-solid fa-arrow-right-from-bracket"></i><span>Sair</span></a>
            </div>
        </div>
        <div class="main">
            <div class="upbar">
                <input class="buscar-inp" type="text" placeholder="Buscar">
                <div class="profile-container">
                    <div class="user-wrap">
                        <img src="../img/user_placeholder.png" class="img-user">
                        <span id="nome-usuario"></span>
                        <i class="fa-solid fa-angle-down"></i>
                    </div>
                    <div>
                        <i class="fa-solid fa-bell"></i>
                    </div>
                </div>
            </div>
            <div class="visao-geral">
                <div class="titulo">
                    Dashboard
                </div>
                <div class="dados-geral">
                    <div class="cards">
                        <div class="card-kpi">
                            <span class="card-title">Perdas em ociosidade</span>
                            <span class="card-user">R$ <span class="card-user-valor">5850,00</span></span>

                        </div>

                        <div class="card-kpi" id="card-kpi-center">
                            <span class="card-title">Tarefas em atraso </span>
                            <span class="card-user"><span id="view_total_tarefas" class="card-user-valor">9 </span>tarefas de <br>
                            <span id="view_total_operadores" class="card-user-valor">7</span> colaboradores</span>
                        </div>

                        <div class="card-kpi">
                            <h4 class="card-title">Satisfação</h4>
                            <div class="satisfacao">
                                <i class="fa-solid fa-face-laugh-beam icon-gerente"></i>
                                <span class="pontuacao">9,3</span>
                                <div class="seta-indicador">
                                    <i class="fa-solid fa-arrow-trend-up"></i>
                                    <span>3,6%</span>
                                </div>
                            </div>

                        </div>
                    </div>
                    <div class="monitorar-atrasados">
                        <div class="tarefas-atrasadas">
                            <canvas id="myChart" class="dash-tarefas"></canvas>
                        </div>
                        <div class="card-op">
                            <span class="card-title-op">Operadores com tarefas atrasadas recorrentes</span>
                            <ul id="view_operadores_atrasos">
                                <!-- <li><span><i class="fa-solid fa-circle-user" style="color: #313131; "></i>Jorge operador</span></li>
                                <li><span><i class="fa-solid fa-circle-user" style="color: #313131; "></i>Jorge operador</span></li>
                                <li><span><i class="fa-solid fa-circle-user" style="color: #313131; "></i>Jorge operador</span></li> -->
                            </ul>
                        </div>
                    </div>
                </div>

            </div>
            <div>

    </section>


</body>

</html>

<script>

    var usuario = sessionStorage.USERNAME_USUARIO;
    const idEmpresa = sessionStorage.ID_EMPRESA_USUARIO;
    var txt_nome = document.getElementById('nome-usuario');
    txt_nome.innerHTML = `${usuario}`

    const ctx = document.getElementById('myChart');
    new Chart(ctx, {
        type: 'bar',
        data: {
            labels: ['Gabriel', 'Denis', 'Juliana', 'Fabiana', 'Paula', 'Fernanda'],
            datasets: [{
                label: 'Tarefas atrasadas ',
                data: [2, 9, 3, 5, 9, 3],
                borderWidth: 2,
                backgroundColor: '#313131',
                borderColor: '#313131'
            },{
                label: 'Tempo ocioso por operador',
                data: [12, 19, 3, 5, 2, 3],
                borderWidth: 2,
                backgroundColor: '#52c3e3',
                borderColor: '#cdcdcd'
            }],
            
            
        },
        options: {
            scales: {
                y: {
                    beginAtZero: true
                }
            },
            plugins: {
                title: {
                    display: true,
                    text: 'Tarefas atrasadas x tempo ocioso por operador',
                    font: {
                        size: 18
                    }
                }
            }
        }, 
        
    });

    var listaTarefas = []
    function buscarTarefasAtrasadas(){
        fetch(`/empresas/buscarTarefasAtrasadas?idEmpresa=${idEmpresa}`).then(res => {
            if (!res.ok) {
                throw new Error(`Erro na solicitação: ${res.statusText}`);
            }
            return res.json();
        })
            .then(res => {
                console.log(res);
                listaTarefas = res;
                exibirTarefasAtrasadas();
            })
            .catch(erro => {
                console.log(erro);
                console.log("Não foi  possivel realizar o select: ", erro);
            })
    }

    function exibirTarefasAtrasadas(){
        let totalTarefas = 0
        let totalOp = 0
        listaTarefas.forEach(t => {
            totalTarefas += t.qtdTarefas;
            totalOp += 1;
        })
        document.getElementById('view_total_tarefas').innerHTML = `${totalTarefas}`
        document.getElementById('view_total_operadores').innerHTML = `${totalOp}`
    }

    var listaOperadoresTarefas = []
    function buscarOperadoresComMaisTarefasAtrasadas(){
        fetch(`/empresas/buscarOperadoresComMaisTarefasAtrasadas?idEmpresa=${idEmpresa}`).then(res => {
            if (!res.ok) {
                throw new Error(`Erro na solicitação: ${res.statusText}`);
            }
            return res.json();
        })
            .then(res => {
                console.log(res);
                listaOperadoresTarefas = res;
                exibirOperadoresComMaisTarefasAtrasadas();
            })
            .catch(erro => {
                console.log(erro);
                console.log("Não foi  possivel realizar o select: ", erro);
            })
    }

    function exibirOperadoresComMaisTarefasAtrasadas(){
        listaOperadoresTarefas.forEach(op => {
            document.getElementById('view_operadores_atrasos').innerHTML += `<li><span><i class="fa-solid fa-circle-user" style="color: #313131; "></i>${op.primeiro_nome} ${op.sobrenome} - ${op.tarefasAtrasadas} em atraso</span></li>`
        })
    }
</script>